import { useEffect, useRef, useState } from "react";
import { getLyricsForSong, LyricLine } from "@/data/lyrics";
import { Mic2 } from "lucide-react";

interface LyricsPanelProps {
  songId: string;
  currentTime: number; // in seconds
  isPlaying: boolean;
}

export const LyricsPanel = ({ songId, currentTime, isPlaying }: LyricsPanelProps) => {
  const lyrics = getLyricsForSong(songId);
  const containerRef = useRef<HTMLDivElement>(null);
  const [activeIndex, setActiveIndex] = useState(0);

  // Find the current lyric based on time
  useEffect(() => {
    const currentIndex = lyrics.reduce((acc, line, index) => {
      if (currentTime >= line.time) {
        return index;
      }
      return acc;
    }, 0);
    setActiveIndex(currentIndex);
  }, [currentTime, lyrics]);

  // Auto-scroll to active lyric
  useEffect(() => {
    if (containerRef.current) {
      const activeElement = containerRef.current.querySelector(`[data-index="${activeIndex}"]`);
      if (activeElement) {
        activeElement.scrollIntoView({
          behavior: "smooth",
          block: "center",
        });
      }
    }
  }, [activeIndex]);

  return (
    <div className="glass rounded-2xl p-6 w-full lg:w-80 h-[400px] flex flex-col">
      {/* Header */}
      <div className="flex items-center gap-2 mb-4 pb-3 border-b border-border/30">
        <Mic2 size={20} className="text-primary" />
        <h3 className="font-semibold text-foreground">Lyrics</h3>
      </div>

      {/* Lyrics Container */}
      <div
        ref={containerRef}
        className="flex-1 overflow-y-auto space-y-4 scrollbar-thin pr-2"
      >
        {lyrics.map((line, index) => (
          <p
            key={`${line.time}-${index}`}
            data-index={index}
            className={`text-center transition-all duration-300 ${
              index === activeIndex
                ? "text-lg font-semibold text-foreground scale-105"
                : index < activeIndex
                ? "text-sm text-muted-foreground/50"
                : "text-sm text-muted-foreground"
            }`}
          >
            {line.text}
          </p>
        ))}
      </div>

      {/* Playing indicator */}
      {isPlaying && (
        <div className="flex justify-center gap-1 mt-4 pt-3 border-t border-border/30">
          <span className="w-1 h-3 bg-primary rounded-full animate-pulse" style={{ animationDelay: "0ms" }} />
          <span className="w-1 h-4 bg-primary rounded-full animate-pulse" style={{ animationDelay: "150ms" }} />
          <span className="w-1 h-3 bg-primary rounded-full animate-pulse" style={{ animationDelay: "300ms" }} />
          <span className="w-1 h-5 bg-primary rounded-full animate-pulse" style={{ animationDelay: "450ms" }} />
          <span className="w-1 h-3 bg-primary rounded-full animate-pulse" style={{ animationDelay: "600ms" }} />
        </div>
      )}
    </div>
  );
};
